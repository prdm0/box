<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Testing modules • box</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Testing modules">
<meta property="og:description" content="box">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">box</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/box.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">General topics</li>
    <li>
      <a href="../articles/testing.html">Testing modules</a>
    </li>
    <li>
      <a href="../articles/compiled-code.html">Using compiled code</a>
    </li>
    <li>
      <a href="../articles/migration.html">Migration guide for version 1.0</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Implementation details</li>
    <li>
      <a href="../articles/mod-env-hierarchy.html">The hierarchy of module environments</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="testing_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Testing modules</h1>
                        <h4 class="author">Konrad Rudolph</h4>
            
            <h4 class="date">2021-03-21</h4>
      
      
      <div class="hidden name"><code>testing.rmd</code></div>

    </div>

    
    
<div id="testing-is-crucial" class="section level2">
<h2 class="hasAnchor">
<a href="#testing-is-crucial" class="anchor"></a>Testing is crucial</h2>
<p>Writing tests to ensure code correctness is a crucial part of developing robust software. This is especially true for dynamic languages such as R, which lack some of the tools that ensure correctness in statically checked programming languages.</p>
<p>‘box’ does not dictate a specific style of testing, and different kinds of testing are appropriate in different situations. However, the following article suggests a structure for the test accompanying a module which I have found to work well.</p>
<p>Following the suggested structure causes the implementation and the tests of each module to be located in paths next to each other. This structure is found in several other conventions across programming languages; but it differs somewhat from the convention of R packages (where all implementation code is in a separate directory from all testing code), and differs drastically from the convention found for instance in Java. That said, it should be possible to make a Java-like test project work with ‘box’, too.</p>
</div>
<div id="support-for-existing-testing-frameworks" class="section level2">
<h2 class="hasAnchor">
<a href="#support-for-existing-testing-frameworks" class="anchor"></a>Support for existing testing frameworks</h2>
<p>‘box’ is agnostic regarding the testing framework. The following example employs the widely used ‘<a href="https://testthat.r-lib.org/">testthat</a>’ unit testing package, but other frameworks exist, and should also work.</p>
<p>This example uses the <a href="bio/seq.r"><code>bio/seq</code></a> module from the <em><a href="box.html">Getting started</a></em> vignette. To enable unit testing, this module contains the following code at the very end:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/name.html">name</a></span>())) {
    <span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">.</span>/<span class="no">`__tests__`</span>)
}</pre></body></html></div>
<p>This allows us to run the tests by running the module source code from the command line, e.g. via</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> bio/seq.r</span></code></pre></div>
<p>… or inside an IDE such as RStudio by choosing the menu item “Tools” › “Jobs” › “Start Local Job…” <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. This works because <code>box::name()</code> returns the name of the module from which this function is called. But if the function is invoked from code that wasn’t loaded via <code>box::use()</code> (as is the case here), its value is <code>NULL</code>. In other words, <code>is.null(box::name())</code> is a way of testing whether the code currently being run is loaded as a module, or executed directly.</p>
<p>The code inside the <code>if</code> imports the <code>__tests__</code> submodule: that’s where we put the unit tests. The name <code>__tests__</code> is a convention. You’re free to choose a different name, but I recommend sticking with this convention. Note that <code>__tests__</code> is not a valid R variable name; that’s why it needs to be written in backticks, i.e. the qualified local module name is <code>./`__tests__`</code>.</p>
<p>In this case, the <code>__tests__</code> submodule consists of a directory with the following contents:</p>
<ul>
<li>
<code>__tests__/</code>
<ul>
<li><a href="bio/__tests__/__init__.r"><code>__init__.r</code></a></li>
<li><a href="bio/__tests__/helper-module.r"><code>helper-module.r</code></a></li>
<li>individual test files</li>
</ul>
</li>
</ul>
<p>The <code>__init__.r</code> file corresponds closely to the file <code>tests/testthat.R</code> in a standard R package structure. It loads ‘testthat’ and launches the tests:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">testthat</span>[<span class="no">...</span>])

<span class="no">.on_load</span> <span class="kw">=</span> <span class="kw">function</span> (<span class="no">ns</span>) {
    <span class="fu">test_dir</span>(<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">file</a></span>())
}</pre></body></html></div>
<p>This first loads and attaches the ‘testthat’ package. Although attaching is not strictly necessary, ‘testthat’ code is a lot more readable without cluttering the code with explicit name qualifications.</p>
<p>Next it invokes <code>test_dir()</code> and passes the tests’ directory via <code>box::file()</code> inside the module’s <code>.on_load()</code> hook — remember that only declarations should be at file level inside a module! All code execution should happen inside functions.</p>
<p>The <code>helper-module.r</code> file is a ‘testthat’ helper; these are sourced automatically by ‘testthat’ in the environment where the tests are run. We use this mechanism to load our module in the test environment:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">..</span>/<span class="no">seq</span>[<span class="no">...</span>])</pre></body></html></div>
<p>And, again, attaching isn’t strictly necessary here. Note also that, depending on how the tests are run, this helper file might not be needed, since executing the module script file itself already loads the module contents into the global namespace; however, not all ways of loading the tests do this; for instance, RStudio’s “Start Local Job” doesn’t. So having this helper is sometimes necessary, and never hurts.</p>
<p>With this set-up, the actual unit test files look exactly like regular ‘testthat’ test files. For instance, here’s <code>__tests__/test-seq.r</code>:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="fu">test_that</span>(<span class="st">'valid sequences can be created'</span>, {
    <span class="fu">expect_error</span>((<span class="no">s</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="st">'GATTACA'</span>)), <span class="fl">NA</span>)
    <span class="fu">expect_true</span>(<span class="fu">is_valid</span>(<span class="no">s</span>))

    <span class="fu">expect_error</span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="st">'cattaga'</span>), <span class="fl">NA</span>)
})

<span class="fu">test_that</span>(<span class="st">'invalid sequences cannot be created'</span>, {
    <span class="fu">expect_error</span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="st">'GATTXA'</span>))
})</pre></body></html></div>
<div id="a-note-on-rstudio-and-other-ides" class="section level3">
<h3 class="hasAnchor">
<a href="#a-note-on-rstudio-and-other-ides" class="anchor"></a>A note on RStudio and other IDEs</h3>
<p>Most IDEs have an option to “Source” a local file. When doing this it may <em>seem</em> as if the tests are correctly run, but this isn’t actually the case! This is because <code>box::use()</code> doesn’t reload code that has already been loaded previously; instead, it uses an already loaded, cached version. This means that running the tests via the “Source” button risks running an outdated version of the tests, or the module, or both, after modifying their code.</p>
<p>To avoid this, always execute the test module in a new R session. In RStudio, the easiest way of doing this is by running it as a job, via the menu “Tools” › “Jobs” › “Start Local Job…” (or using the option “Source as Local Job…” in the “Source” drop-down).</p>
</div>
</div>
<div id="test-interfaces-not-implementation-details" class="section level2">
<h2 class="hasAnchor">
<a href="#test-interfaces-not-implementation-details" class="anchor"></a>Test interfaces, not implementation details</h2>
<p>One big difference between testing module code and testing package code is that, with the testing structure laid out above, the testing code only sees the module’s public interface, it does not get access to the internal module implementation.<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<p>This is <em>by design</em>: the idea is that we want to test the <em>observable behaviour</em> rather than the (purely incidental) current implementation, which might be changed. This is the way unit testing works in many other environments, and how it is often recommended.</p>
<p>But I realise that this may not always be appropriate. Sometimes we <em>need</em> to test implementation details. There are essentially two workarounds for this. For the moment, I have not yet developed a strong preference for either of these methods.</p>
<ol style="list-style-type: decimal">
<li>
<p>Put the tests into the module files themselves.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="co"># mymod.r</span>

<span class="no">this_works</span> <span class="kw">=</span> <span class="kw">function</span> () <span class="fl">TRUE</span>

<span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/name.html">name</a></span>())) {
    <span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">testthat</span>[<span class="no">...</span>])

    <span class="co"># Define tests</span>

    <span class="fu">test_that</span>(<span class="st">'implementation detail X works'</span>, {
        <span class="fu">expect_true</span>(<span class="fu">this_works</span>())
    })

    <span class="co"># Invoke tests</span>

    <span class="fu">test_file</span>(<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/r/base/connections.html">file</a></span>())
}</pre></body></html></div>
</li>
<li>
<p>Get access to the private module namespace for testing. When loading a module with <code>box::use()</code>, the module object has an attribute <code>namespace</code> that holds the private module namespace. It generally shouldn’t be accessed by client code, but access by the testing code for a module is entirely legitimate:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># __tests__/test-something.r</span>

<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">..</span>/<span class="no">mymod</span>)

<span class="no">impl</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span>(<span class="no">mymod</span>, <span class="st">'namespace'</span>)

<span class="fu">test_that</span>(<span class="st">'implementation detail X works'</span>, {
    <span class="fu">expect_true</span>(<span class="no">impl</span>$<span class="fu">this_works</span>())
})</pre></body></html></div>
</li>
</ol>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>It may be tempting to instead use the “Source” button but doing so is problematic; see the section “A note on RStudio and other IDEs”!<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Depending on how it’s invoked; but we shouldn’t make assumptions. In particular, when invoked as a job in RStudio, the test module is loaded via the test helper, and thus the module internals are not visible.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://klmr.me">Konrad Rudolph</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
