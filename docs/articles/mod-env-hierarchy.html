<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The hierarchy of module environments • box</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="The hierarchy of module environments">
<meta property="og:description" content="box">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">box</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/box.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">General topics</li>
    <li>
      <a href="../articles/testing.html">Testing modules</a>
    </li>
    <li>
      <a href="../articles/compiled-code.html">Using compiled code</a>
    </li>
    <li>
      <a href="../articles/migration.html">Migration guide for version 1.0</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Implementation details</li>
    <li>
      <a href="../articles/mod-env-hierarchy.html">The hierarchy of module environments</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mod-env-hierarchy_files/header-attrs-2.1/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>The hierarchy of module environments</h1>
                        <h4 class="author">Konrad Rudolph</h4>
            
            <h4 class="date">2021-03-21</h4>
      
      
      <div class="hidden name"><code>mod-env-hierarchy.rmd</code></div>

    </div>

    
    
<blockquote>
<p><strong>Note:</strong> This document describes internal implementation details. They are not required knowledge for users of the ‘box’ package and module authors.</p>
</blockquote>
<div id="preliminaries" class="section level2">
<h2 class="hasAnchor">
<a href="#preliminaries" class="anchor"></a>Preliminaries</h2>
<p>To ensure that module environments are properly isolates from each other, and to enable fine-grained control over imports and exports, loaded modules (as well as packages loaded via <code>box::use</code>) correspond to a mesh of several interconnected environments.</p>
<p>Unfortunately the exact relationship between these environments isn’t trivial, so the following document aims at explaining the gist.</p>
<p>Fundamentally, module environments follow a similar architecture to package environments, but they deviate in crucial ways. For a good explanation of package environments, see <a href="http://blog.obeautifulcode.com/R/How-R-Searches-And-Finds-Stuff/"><em>How R Searches and Finds Stuff</em></a> by Suraj Gupta, and <a href="http://adv-r.had.co.nz/Environments.html"><em>Environments</em></a> in <em>Advanced R</em> by Hadley Wickham. The following assumes that the reader has a more than passing familiarity with these concepts.</p>
<p>When speaking of “package environments” above and in the following, this refers to packages as handled by base R and the R package namespace functionality. For packages that are loaded by <code>box::use</code>, the rules are the same as for modules.</p>
<p>Let’s now consider an example of several loaded modules, and how they interact.</p>
</div>
<div id="an-example" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example" class="anchor"></a>An example</h2>
<p>This example will use three modules — the minimum number necessary to show some of the interactions of the module environments. Let’s define these three modules. We’ll do so in inverse order of their usage:</p>
<div id="c-r" class="section level3">
<h3 class="hasAnchor">
<a href="#c-r" class="anchor"></a><code><span style="background: #1DB100; color: white; padding: 0 5px; border-radius: 2px;">c.r</span></code>
</h3>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="co">#' @export</span>
<span class="no">f</span> <span class="kw">=</span> <span class="kw">function</span> () <span class="st">"c$f"</span></pre></body></html></div>
<p>Module <code>c</code> defines and exports one name, the function <code>f</code>.</p>
</div>
<div id="b-r" class="section level3">
<h3 class="hasAnchor">
<a href="#b-r" class="anchor"></a><code><span style="background: #FF9300; color: white; padding: 0 5px; border-radius: 2px;">b.r</span></code>
</h3>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="co">#' @export</span>
<span class="no">f</span> <span class="kw">=</span> <span class="kw">function</span> () <span class="st">"b$f"</span>

<span class="no">g</span> <span class="kw">=</span> <span class="kw">function</span> () <span class="st">"b$g"</span></pre></body></html></div>
<p>Module <code>b</code> defines and exports the function <code>f</code>, and in addition defines the function <code>g</code>.</p>
</div>
<div id="a-r" class="section level3">
<h3 class="hasAnchor">
<a href="#a-r" class="anchor"></a><code><span style="background: #00A2FF; color: white; padding: 0 5px; border-radius: 2px;">a.r</span></code>
</h3>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="co">#' @export</span>
<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">.</span>/<span class="no">b</span>[<span class="kw">g</span> <span class="kw">=</span> <span class="no">f</span>, <span class="no">...</span>])

<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">.</span>/<span class="no">c</span>[<span class="no">...</span>])

<span class="co">#' @export</span>
<span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="no">.</span>/<span class="no">c</span>)

<span class="co">#' @export</span>
<span class="no">f</span> <span class="kw">=</span> <span class="kw">function</span> () <span class="st">"a$f"</span>

<span class="no">f_of_c1</span> <span class="kw">=</span> <span class="no">c</span>$<span class="no">f</span>
<span class="no">f_of_c2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/get.html">get</a></span>(<span class="st">'f'</span>, <span class="fu"><a href="https://rdrr.io/r/base/environment.html">parent.env</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/environment.html">environment</a></span>()))
<span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(<span class="no">f_of_c1</span>, <span class="no">f_of_c2</span>))</pre></body></html></div>
<p>Module <code>a</code> imports and re-exports all names from <code>b</code> (changing the name of <code>b$f</code> to <code>g</code>); it also imports, but does not re-export, all names from <code>c</code> (and, additionally, defines an alias for the module, which it exports).</p>
<p>It further defines and exports the function <code>f</code> and defines, but does not export, the functions <code>f_of_c1</code> and <code>f_of_c2</code> (which are defined such that they are identical to each other — hopefully it will become clear why later).</p>
<p>Finally, let’s use the modules by executing the following code:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="kw pkg">box</span><span class="kw ns">::</span><span class="fu">use</span>(<span class="kw">a</span> <span class="kw">=</span> <span class="no">.</span>/<span class="no">a</span>[<span class="no">f</span>, <span class="no">g</span>])</pre></body></html></div>
<p>Now the name <code>a</code> is defined in <code>.GlobalEnv</code> and refers to the module environment of module <code>a</code>. The exported names <code>f</code> and <code>g</code> of <code>a</code> are also available in <code>.GlobalEnv</code> (but not defined <em>inside</em> <code>.GlobalEnv</code>).</p>
<p>The loaded modules can be represented by the following schematic, with each box corresponding to an environment:</p>
<p><img src="environment-schema.png"></p>
<p>Let’s go over the different types of environment associated with each module, and how they are connected.</p>
</div>
</div>
<div id="environments" class="section level2">
<h2 class="hasAnchor">
<a href="#environments" class="anchor"></a>Environments</h2>
<div id="module-namespace" class="section level3">
<h3 class="hasAnchor">
<a href="#module-namespace" class="anchor"></a>Module namespace</h3>
<p>Modules are loaded into their own dedicated environment, the <em>module namespace</em>. Every name that is defined by a module is defined inside it. It is thus also the enclosing environment of the module’s functions. Lastly, the module namespace also stores meta-information about the module in a hidden member named <code>.__module__.</code>.</p>
<p>This corresponds to the package namespace.</p>
</div>
<div id="module-imports-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#module-imports-environment" class="anchor"></a>Module imports environment</h3>
<p>The parent environment of the module namespace is the imports environment, which contains all the names that a module imports via attachment declarations in <code>box::use</code> expressions.</p>
<p>The parent environment of the imports environment is the R <code>base</code> namespace environment. The module imports environment thus corresponds to the package imports environment.</p>
</div>
<div id="module-export-environment" class="section level3">
<h3 class="hasAnchor">
<a href="#module-export-environment" class="anchor"></a>Module export environment</h3>
<p>The module export environment, also called just “module environment” in the code base, contains all names that are marked as exported by a module. If users create a module alias in their <code>box::use</code> call, the alias will be a reference to this environment.</p>
<p>Similarly, attached names are selected as a subset from the module export environment (then copied into the imports environment).</p>
<p>There is no direct equivalent to this environment in R packages, because R packages do not distinguish between exported names and names imported by the code that loaded the package. By contrast, ‘box’ needs to distinguish the set of exports from the set of names that are imported (= “attached”) by client code.</p>
</div>
<div id="importing-into-other-environments" class="section level3">
<h3 class="hasAnchor">
<a href="#importing-into-other-environments" class="anchor"></a>Importing into other environments</h3>
<p>Module import environments store imports from one or more module into another. However, modules can also be imported from inside the global environment, or from inside functions, which have their own local execution environment (the stack frame). When this happens, a new imports environment is created on the fly, and attached to the importing environment’s <code>parent.env</code> chain. Calling <code>box::use</code> with a non-empty attach list in <code>.GlobalEnv</code> is therefore similar to calling <code>library</code>. In particular, inside <code>.GlobalEnv</code> the call <code>box::use(pkg[...])</code> in pretty much equivalent to calling <code>library(pkg)</code>, and is discouraged for the same reason that <code>library(pkg)</code> is discouraged.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://klmr.me">Konrad Rudolph</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
